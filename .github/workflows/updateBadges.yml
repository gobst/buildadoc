name: Update badges

on:
  push:
    branches:
      - develop

jobs:
  update-badges:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub packages
        run: echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pull image
        run: |
          docker-compose -f docker-compose.yml -p buildadoc-dev up -d --build buildadoc-dev

      - name: Run composer
        run: |
          docker-compose -f docker-compose.yml -p buildadoc-dev exec -T buildadoc-dev sh -c "composer install"

      - name: Run unit tests
        run: |
          mkdir -p bin/output
          docker-compose -f docker-compose.yml -p buildadoc-dev exec -T buildadoc-dev sh -c "XDEBUG_MODE=coverage ./scripts/test/phpunit.sh run"
          docker cp buildadoc-dev_container:/var/www/html/BuildADoc/bin/output/unit/coverage.txt bin/output

      - name: Run mutation tests
        run: |
          mkdir -p bin/output/mutation
          docker-compose -f docker-compose.yml -p buildadoc-dev exec -T buildadoc-dev sh -c "XDEBUG_MODE=coverage ./scripts/test/infectionPHP.sh"
          docker cp buildadoc-dev_container:/var/www/html/BuildADoc/bin/output/mutation/summary.log bin/output/mutation

      - name: Update code coverage badge in README file
        run: |
          # Extract the coverage percentage from the coverage.xml file
          COVERAGE=$(grep -oP 'Lines:\s+\K[0-9.]+%' bin/output/coverage.txt)
          # Generate the badge link
          BADGE="[![Code Coverage](https://img.shields.io/badge/Code_Coverage-${COVERAGE}25-brightgreen)](https://img.shields.io/badge/Code_Coverage-${COVERAGE}25-brightgreen)"
          # Update README file
          if [ ! -s README.md ]; then
            echo "$BADGE" >> README.md
          else
            sed -i "s|\[!\[Code Coverage\].*](.*)|$BADGE|g" README.md || echo "$BADGE" >> README.md
          fi

      - name: Update MSI badge in README file
        run: |
          # Extract values from summary.log file
          TOTAL=$(grep -E 'Total' bin/output/mutation/summary.log | grep -Eo '[0-9]+')
          KILLED=$(grep -E 'Killed' bin/output/mutation/summary.log | grep -Eo '[0-9]+')
  
          # Calculate MSI
          MSI=$(echo "scale=4; $KILLED / $TOTAL * 100" | bc)
          MSI=$(printf "%.2f\n" $MSI)
  
          # Generate badge link
          BADGE="[![Mutation Score](https://img.shields.io/badge/Mutation_Score-${MSI}%25-brightgreen)](https://img.shields.io/badge/Mutation_Score-${MSI}%25-brightgreen)"
  
          # Update README file
          if [ ! -s README.md ]; then
            echo "$BADGE" >> README.md
          else
            sed -i "s|\[!\[Mutation Score\].*](.*)|$BADGE|g" README.md || echo "$BADGE" >> README.md
          fi

      - name: Commit and push changes
        run: |
          if git log -1 --pretty=format:'' --name-only | grep -q README.md; then
            git config --global user.email "github@sourcegate.de"
            git config --global user.name "gobst"
            git add README.md
            git commit -m "Update badges. This commit was created automatically."
            git push
          fi