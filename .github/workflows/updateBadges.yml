name: Update Code Coverage Badge

on:
  push:
    branches:
      - develop

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub packages
        run: echo "${{ secrets.TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pull image
        run: |
          docker-compose -f docker-compose.yml -p buildadoc-dev up -d --build buildadoc-dev

      - name: Run composer
        run: |
          docker-compose -f docker-compose.yml -p buildadoc-dev exec -T buildadoc-dev sh -c "composer install"

      - name: Run unit tests
        run: |
          mkdir -p bin/output
          docker-compose -f docker-compose.yml -p buildadoc-dev exec -T buildadoc-dev sh -c "XDEBUG_MODE=coverage ./scripts/test/phpunit.sh run"
          docker cp buildadoc-dev_container:/var/www/html/BuildADoc/bin/output/unit/coverage.txt bin/output

      - name: Update coverage badge in README file
        run: |
          # Extract the coverage percentage from the coverage.xml file
          COVERAGE=$(grep -oP 'Lines:\s+\K[0-9.]+%' bin/output/coverage.txt)
          # Generate the badge link
          BADGE="[![Code Coverage](https://img.shields.io/badge/Coverage-${COVERAGE}25-brightgreen)](https://img.shields.io/badge/Code-Coverage-${COVERAGE}25-brightgreen)"
          # Check if the README.md file is empty
          if [ ! -s README.md ]; then
            echo "$BADGE" >> README.md
          else
            sed -i "s|\[!\[Code Coverage\].*](.*)|$BADGE|g" README.md || echo "$BADGE" >> README.md
          fi

      - name: Commit and push changes
        run: |
          git config --global user.email "github@sourcegate.de"
          git config --global user.name "gobst"
          git commit -m "Update code coverage badge"
          git push
